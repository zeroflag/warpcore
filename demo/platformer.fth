[ $6000 ] CONSTANT PAL
[ $6200 ] CONSTANT SPR

[ 79  ] CONSTANT KEY_RIGHT
[ 80  ] CONSTANT KEY_LEFT
[ 82  ] CONSTANT KEY_UP
[ 44  ] CONSTANT KEY_SPACE
[ 200 ] CONSTANT PORT_KB
[ 400 ] CONSTANT PORT_SCROLL

[ 32  ] CONSTANT #TILES_X  
[ 28  ] CONSTANT #TILES_Y
[  8  ] CONSTANT TILE_WIDTH
[  8  ] CONSTANT TILE_HEIGHT

[  1  ] CONSTANT SOLID
[  2  ] CONSTANT AIR
[  3  ] CONSTANT SPIKE

[  1  ] CONSTANT  AX
[ -1  ] CONSTANT -AX
[  5  ] CONSTANT  BRAKING_AX
[ -5  ] CONSTANT -BRAKING_AX
[  3  ] CONSTANT  FRICTION
[  5  ] CONSTANT  GRAVITY
[ -20 ] CONSTANT  JUMP_SPEED
[  50 ] CONSTANT  MAX_FALL
[  10 ] CONSTANT  AY
[  20 ] CONSTANT  MAX_VX
[ -20 ] CONSTANT  MIN_VX
[  6  ] CONSTANT  MAX_JUMP
[ 100 ] CONSTANT  SCROLL_START_X_RIGHT
[ 180 ] CONSTANT  SCROLL_START_X_LEFT

VARIABLE ANIMATION
VARIABLE ANIM_TIMER
VARIABLE JUMP_TIMER
VARIABLE TIMER
VARIABLE DT
VARIABLE CAM_X

CREATE PLAYER [
  SPR   ,  ( SPRITE )
  0     ,  ( WORLD X COORD. )
  0     ,  ( WORLD Y COORD. )
  8     ,  ( WIDTH )
  8     ,  ( HEIGHT )
  0     ,  ( WORLD SUBPIXEL X )
  0     ,  ( WORLD SUBPIXEL Y )
  0     ,  ( VX )
  0     ,  ( VY )
  FALSE ,  ( JUMPING )
  0     ,  ( LAST FACING )
  0     ,  ( KEYS  COLLECTED )
  0     ,  ( COINS COLLECTED )
]

: .WX          CELL  + ;
: .WY        2 CELLS + ;
: .WIDTH     3 CELLS + ;
: .HEIGHT    4 CELLS + ;
: .SX        5 CELLS + ;
: .SY        6 CELLS + ;
: .VX        7 CELLS + ;
: .VY        8 CELLS + ;
: .JUMPING   9 CELLS + ;
: .FACING    10 CELLS + ;
: .KEYS      11 CELLS + ;
: .COINS     12 CELLS + ;

: .CENTER ( player -- x y )
  DUP  .WX @ OVER .WIDTH  @ 2 / +
  OVER .WY @ ROT  .HEIGHT @ 2 / + ;

: .TILE ( player -- tx ty )
  .CENTER TILE_HEIGHT /
   SWAP   TILE_WIDTH  /
   SWAP ;

CREATE IDLE [
  0  C,  ( INDEX )
  3  C,  ( SIZE  )
  81 C,  ( TILES )
  82 C,
  83 C,
]

CREATE RUNNING [
  0   C,  ( INDEX )
  4   C,  ( SIZE  )
  99  C,  ( TILES )
  100 C,
  101 C,
  102 C,
]

CREATE DOOR_1 [
  6   ,  ( X ENTRY )
  22  ,  ( Y ENTRY )
  28  ,  ( X EXIT )
  5   ,  ( Y EXIT )
  0   C, ( STATUS )
]

CREATE DOOR_2 [
  40  ,  ( X ENTRY )
  4   ,  ( Y ENTRY )
  61  ,  ( X EXIT )
  22  ,  ( Y EXIT )
  0   C, ( STATUS )
]

CREATE DOORS [ 2 C, ( SIZE ) DOOR_1 , DOOR_2 , ]

( Palette )
.DB $6000
  $FF $6A $ED $FF
  $FF $FF $FF $FF
  $8E $74 $62 $FF
  $20 $DF $FF $FF
  $94 $01 $8A $FF
  $12 $07 $9F $FF
  $36 $2C $FB $FF
  $01 $63 $3C $FF
  $35 $CF $7C $FF
  $F4 $A6 $34 $FF
  $D7 $2D $43 $FF
  $6F $78 $18 $FF
  $3E $6A $A8 $FF
  $00 $00 $00 $FF
  $B3 $DE $F5 $FF
  $13 $45 $8B $FF
.END

( Screen )
.DB $6300
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 63 63 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 42 42 42 63 63 63 63 63 48 63 63 63 63 48 63 63 63 63 63 63 63 63 63 63 42 63 42 63 42 63 42 63 42 63 42 63 42 63 63 63 63 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 63 63 63 63 60 63 63 63 63 63 63 63 63 63 63 60 57 57 50 51 52 60 57 50 51 52 58 59 57 63 63 63 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 58 59 63 63 63 63 63 63 48 43 57 63 58 48 63 63 63 63 63 63 63 63 63 27 28 28 28 28 28 28 28 28 28 28 28 28 28 29 63 42 63 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 42 42 42 63 63 48 48 48 48 48 63 63 63 63 27 28 28 28 28 29 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63
63 63 63 63 42 42 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 42 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 63 42 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 45 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 42 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63
63 63 63 48 63 63 48 63 63 63 63 27 28 29 63 63 63 63 63 39 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 42 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63
63 63 48 42 42 42 42 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 7 61 61 61 61 61 7 63 63 63 48
63 63 48 42 42 42 42 48 63 63 63 63 63 63 63 48 63 63 50 51 52 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 48 63 63 63 63 63 63 63 63 57 58 63 63 63 63 12 64 64 64 64 64 12 63 63 63 63
63 63 48 42 42 42 42 48 63 63 63 63 63 63 63 63 63 63 27 28 29 63 63 63 63 39 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 27 28 29 63 63 63 12 64 64 64 64 64 12 63 63 63 63
63 63 63 48 48 48 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 42 63 42 63 63 63 63 59 57 60 63 63 63 63 63 63 63 63 48 18 48 48 64 48 48 20 48 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 60 63 63 63 63 63 42 63 63 63 63 63 63 63 63 63 27 28 29 63 63 63 63 63 63 63 63 63 63 63 48 64 48 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 27 28 29 63 63 63 63 63 63 63 50 51 52 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 64 63 63 63 63 63 48 63
63 63 63 63 63 63 42 42 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 42 63 63 63 48 48 48 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 64 63 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 48 48 48 48 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 42 63 63 63 64 63 63 63 63 63 63 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 42 63 63 42 63 63 63 63 63 63 42 63 63 63 48 48 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 64 63 63 63 48 48 63 63
63 63 63 63 63 39 39 39 39 63 63 63 63 63 63 42 63 63 63 63 63 63 42 63 63 63 63 63 63 63 48 48 48 48 63 63 48 48 48 48 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 64 63 63 48 63 63 48 63
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 48 48 48 48 63 48 48 48 48 48 48 63 63 63 63 63 63 63 63 63 63 63 3 63 63 63 64 63 48 63 63 63 63 48
63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 63 48 48 48 48 48 48 63 42 63 48 48 48 48 48 63 63 63 63 63 63 63 63 63 63 12 63 63 63 64 63 48 63 63 63 63 48
57 63 57 57 60 57 63 59 57 60 50 51 52 57 63 63 63 63 48 48 63 63 63 57 57 60 58 48 48 48 48 48 48 48 63 63 63 48 48 48 48 48 48 57 59 50 51 52 58 60 57 57 12 63 57 63 64 63 48 43 60 63 58 48
1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 63 63 63 63 63 63 63 63 0 1 1 1 1 1 1 1 1 1 1 1 2 63 42 0 1 1 1 1 1 1 1 1 1 1 1 1 1 10 1 1 61 64 61 1 1 1 1 1 1
10 10 10 10 10 10 10 10 10 10 10 10 10 10 11 61 61 61 61 61 61 61 61 9 10 10 10 10 10 10 10 10 10 10 10 11 63 63 18 19 19 19 19 19 23 48 48 48 48 48 48 48 48 48 48 64 64 64 48 10 10 10 10 10
10 10 10 10 10 10 10 10 10 10 10 10 10 10 11 64 64 64 64 64 64 64 64 9 10 10 10 10 10 10 10 10 10 10 10 11 57 63 42 57 42 57 42 57 42 63 42 63 42 63 42 63 63 48 10 48 64 48 10 10 10 10 10 10
10 10 10 10 10 10 10 10 10 10 10 10 10 10 11 64 64 64 64 64 64 64 64 9 10 10 10 10 10 10 10 10 10 10 10 10 1 1 1 1 1 1 1 1 1 48 59 58 59 63 63 63 45 48 10 11 64 9 10 10 10 10 10 10
10 10 10 10 10 10 10 10 10 10 10 10 10 10 11 64 64 64 64 64 64 64 64 9 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 48 48 48 48 48 70 48 48 48 10 11 64 9 10 10 10 10 10 10
.END

( TILES )
.DB $4000
  $08 $B8 $B8 $B8 $7B $7B $7B $7B $7B $7B $7B $7B $77 $77 $77 $D7 $D7 $77 $DD $ED $FD $DD $EE $EE $FC $CC $EE $EE $FC $CC $EE $EE
  $B8 $B8 $B8 $B8 $7B $7B $7B $7B $7B $7B $7B $7B $77 $77 $77 $D7 $D7 $77 $DD $ED $CD $DD $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE
  $B8 $B8 $B8 $B0 $7B $7B $7B $7B $7B $7B $7B $7B $77 $77 $77 $D7 $D7 $77 $DD $ED $CD $DD $EE $EF $CC $CC $EE $EF $CC $CC $EE $EF
  $08 $B8 $B8 $B0 $7B $7B $7B $7B $7B $7B $7B $7B $77 $77 $77 $D7 $D7 $77 $DD $ED $FD $DD $EE $EF $FC $CC $EE $EF $FC $CC $EE $EF
  $08 $B8 $B8 $B0 $7B $7B $7B $7B $7B $7B $7B $7B $77 $77 $77 $D7 $D7 $77 $DD $ED $FD $DD $EE $EF $FC $CC $EE $EF $0F $FF $FF $00
  $B0 $00 $00 $00 $78 $00 $00 $00 $7B $B0 $00 $00 $7B $78 $00 $00 $D7 $7B $B0 $00 $C7 $7B $78 $00 $CD $77 $7B $B0 $CC $D7 $7B $78
  $00 $00 $00 $0B $00 $00 $00 $87 $00 $00 $0B $B7 $00 $00 $87 $B7 $00 $0B $B7 $7D $00 $87 $B7 $7E $0B $B7 $77 $DE $87 $B7 $7D $EE
  $0F $FF $FF $F0 $FE $EE $CC $CF $FE $EE $CC $CF $FE $EE $CC $CF $FC $CC $EE $EF $FC $CC $EE $EF $FC $CC $EE $EF $FC $CC $EE $EF
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $FE $EE $CC $CC $FE $EE $CC $CC $FE $EE $CC $CC $FE $EE $CC $CC $FC $CC $EE $EE $FC $CC $EE $EE $FC $CC $EE $EE $FC $CC $EE $EE
  $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE
  $EE $EE $CC $CF $EE $EE $CC $CF $EE $EE $CC $CF $EE $EE $CC $CF $CC $CC $EE $EF $CC $CC $EE $EF $CC $CC $EE $EF $CC $CC $EE $EF
  $FE $EE $CC $CF $FE $EE $CC $CF $FE $EE $CC $CF $FE $EE $CC $CF $FC $CC $EE $EF $FC $CC $EE $EF $FC $CC $EE $EF $FC $CC $EE $EF
  $0F $FF $FF $F0 $FE $EE $CC $CF $FE $EE $CC $CF $FE $EE $CC $CF $FC $CC $EE $EF $FC $CC $EE $EF $FC $CC $EE $EF $0F $FF $FF $F0
  $EE $ED $D7 $7B $EE $EE $CD $DB $EE $EE $CC $C7 $EE $EE $CC $CD $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE
  $B7 $7D $DC $CC $BD $DE $CC $CC $7E $EE $CC $CC $DE $EE $CC $CC $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE
  $FE $EE $CC $CF $FE $EE $CC $CF $FE $EE $CC $CF $FE $EE $CC $CF $FC $CC $EE $EF $FC $CC $EE $EF $FC $CC $EE $EF $0F $FF $FF $F0
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $FE $EE $CC $CC $FE $EE $CC $CC $FE $EE $CC $CC $FE $EE $CC $CC $FC $CC $EE $EE $FC $CC $EE $EE $FC $CC $EE $EE $0F $FF $FF $FF
  $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $FF $FF $FF $FF
  $EE $EE $CC $CF $EE $EE $CC $CF $EE $EE $CC $CF $EE $EE $CC $CF $CC $CC $EE $EF $CC $CC $EE $EF $CC $CC $EE $EF $FF $FF $FF $F0
  $FE $EE $CC $CF $FE $EE $CC $CF $FE $EE $CC $CF $FE $EE $CC $CF $FC $CC $EE $EF $FC $CC $EE $EF $FC $CC $EE $EF $0F $FF $FF $F0
  $FE $EE $CC $CC $FE $EE $CC $CC $FE $EE $CC $CC $FE $EE $CC $CC $FC $CC $EE $EE $FC $CC $EE $EE $FC $CC $EE $EE $FF $FF $FF $FF
  $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $FF $FF $FF $FF
  $EE $EE $CC $CF $EE $EE $CC $CF $EE $EE $CC $CF $EE $EE $CC $CF $CC $CC $EE $EF $CC $CC $EE $EF $CC $CC $EE $EF $FF $FF $FF $FF
  $B8 $B8 $B8 $CC $7B $7B $7B $CC $7B $7B $7D $CC $7D $77 $DC $CC $DC $DD $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE
  $EE $B8 $B8 $B8 $EE $7B $7B $7B $EE $DB $7B $7B $EE $ED $77 $D7 $CC $CC $DD $ED $CC $CC $EE $EE $CC $CC $EE $EE $CC $CC $EE $EE
  $08 $B8 $B8 $B8 $7B $7B $7B $7B $7B $7B $7B $7B $77 $77 $77 $D7 $D7 $77 $DD $ED $FD $DD $EE $EE $FC $CC $EE $EE $0F $FF $FF $FF
  $B8 $B8 $B8 $B8 $7B $7B $7B $7B $7B $7B $7B $7B $77 $77 $77 $D7 $D7 $77 $DD $ED $CD $DD $EE $EE $CC $CC $EE $EE $FF $FF $FF $FF
  $B8 $B8 $B8 $B0 $7B $7B $7B $7B $7B $7B $7B $7B $77 $77 $77 $D7 $D7 $77 $DD $ED $CD $DD $EE $EF $CC $CC $EE $EF $FF $FF $FF $F0
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $FF $FF $00 $0F $DD $DD $F0 $FD $DD $DD $DF
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $FF $FF $00 $0F $EC $CE $F0 $FE $CE $EC $EF
  $0F $FF $FF $F0 $FE $EE $EE $EF $FE $E1 $1E $EF $FE $E1 $1E $EF $FE $EE $EE $EF $FE $E1 $1E $EF $FE $EE $EE $EF $0F $FF $FF $F0
  $0F $FF $FF $F0 $FE $EE $EE $EF $FE $E2 $2E $EF $FE $E2 $2E $EF $FE $EE $EE $EF $FE $E2 $2E $EF $FE $EE $EE $EF $0F $FF $FF $F0
  $0F $FF $FF $F0 $FE $EE $FE $EF $FF $FF $FF $FF $FE $FE $EE $EF $FF $FF $FF $FF $FE $EE $EF $EF $FE $EE $EF $EF $0F $FF $FF $F0
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $03 $33 $00 $00 $33 $33 $30 $00 $33 $33 $30 $00 $03 $33 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $EE $EE $EE $EE $EC $CC $CC $CE $EF $FF $FF $FE $EE $EE $EE $EE $EF $FE $EF $FE $EC $CF $FC $CE $EC $CC $CC $CE $EE $EE $EE $EE
  $0E $EE $EE $E0 $CD $DE $ED $DC $CD $DD $DD $DC $FD $DD $DD $DF $EF $FF $FF $FE $EC $CC $CC $CE $EC $CC $CC $CE $EE $EE $EE $EE
  $03 $33 $33 $00 $03 $30 $33 $00 $03 $33 $33 $00 $00 $03 $30 $00 $00 $33 $30 $00 $00 $03 $30 $00 $00 $33 $30 $00 $00 $00 $00 $00
  $FD $DD $DD $DF $FD $DD $DD $DF $FD $DD $DD $DF $FD $DD $DD $DF $FD $DD $DD $DF $FD $DD $DD $DF $FD $DD $DD $DF $FD $DD $DD $DF
  $FE $CE $EC $EF $FE $CE $EC $EF $F2 $EE $ED $EF $FE $CE $DD $EF $FE $CE $ED $EF $F2 $EE $DD $EF $FE $CE $EC $EF $FE $CE $EC $EF
  $07 $77 $77 $70 $7E $EE $22 $27 $FE $EE $22 $2F $FE $EE $22 $2F $F2 $22 $EE $EF $F2 $22 $EE $EF $F2 $22 $EE $EF $0F $FF $FF $F0
  $0E $EE $EE $E0 $EE $E1 $1E $EE $EE $E1 $1E $EE $EE $EE $EE $EE $EE $E1 $1E $EE $CE $EE $EE $EC $0C $CE $EC $C0 $00 $0E $E0 $00
  $00 $00 $00 $00 $00 $00 $0E $00 $00 $00 $EE $E0 $00 $00 $EE $E0 $00 $00 $EE $EE $00 $00 $EE $EE $00 $00 $EE $EC $00 $00 $EE $E0
  $00 $00 $00 $00 $0E $00 $0E $00 $EE $E0 $EE $E0 $EE $E0 $EE $E0 $EE $EE $EE $EE $EC $EE $EE $EE $EE $EC $EE $EC $EE $E0 $EE $E0
  $00 $00 $00 $00 $0E $00 $00 $00 $EE $E0 $00 $00 $EE $E0 $00 $00 $EE $E0 $00 $00 $EE $E0 $00 $00 $EE $E0 $00 $00 $EE $E0 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $10 $11 $01 $11 $00 $00 $00 $00 $01 $10 $00 $00 $11 $11 $01 $00 $11 $11 $00 $00 $01 $10
  $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $10 $11 $01 $11 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $B0 $00 $00 $B0 $B0 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $E0 $00 $00 $EE $EE $00 $0E $EE $EE $E0
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $EE $00 $00 $0E $EE $E0 $EE
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $60 $00 $00 $06 $06 $00 $00 $00 $60 $00 $00 $00 $B0 $0B $00
  $00 $01 $11 $00 $00 $19 $99 $10 $11 $99 $99 $91 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11 $11
  $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99 $99
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $CC $00 $00 $CC $CC $C0 $0C $CE $EC $C0 $0C $ED $ED $00 $00 $66 $66 $00 $06 $EB $BE $00 $00 $BB $B0 $00 $00 $F0 $F0 $00
  $00 $00 $00 $00 $00 $0C $C0 $00 $00 $CC $CC $C0 $0C $CE $CC $C0 $6C $ED $ED $00 $06 $66 $66 $00 $00 $EB $BE $00 $00 $F0 $F0 $00
  $00 $00 $CC $00 $00 $CC $CC $C0 $0C $CE $EC $C0 $06 $ED $ED $00 $60 $66 $66 $00 $00 $EB $BE $00 $00 $BB $B0 $00 $00 $F0 $F0 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $CC $00 $00 $CC $CC $C0 $0C $CE $EC $C0 $00 $ED $ED $00 $00 $66 $66 $00 $06 $EB $BE $00 $00 $BB $BF $00 $0F $00 $00 $00
  $00 $00 $CC $00 $00 $0C $CC $00 $00 $CC $CC $00 $0C $CE $EE $00 $6C $ED $ED $00 $06 $66 $66 $00 $00 $EB $BE $00 $00 $0F $0F $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $CC $C0 $00 $0C $CC $CC $00 $0C $EC $CC $00 $0C $DE $DC $00 $0E $66 $6E $00 $06 $BB $B0 $00 $00 $BB $B0 $00 $0F $00 $0F $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $CC $00 $00 $CC $CC $C0 $0C $CE $EC $C0 $0C $ED $ED $00 $06 $66 $66 $00 $00 $EB $BE $00 $00 $BB $B0 $00 $0F $00 $0F $00
  $00 $00 $CC $00 $00 $CC $CC $C0 $0C $CE $EC $C0 $06 $ED $ED $00 $00 $66 $66 $00 $00 $EB $BE $00 $00 $BB $B0 $00 $00 $F0 $F0 $00
  $00 $00 $00 $00 $00 $00 $CC $00 $00 $CC $CC $C0 $0C $CE $CC $C0 $06 $ED $EC $C0 $00 $66 $66 $00 $00 $EB $BE $00 $00 $FF $00 $00
  $00 $00 $CC $00 $00 $CC $CC $C0 $0C $CE $EC $C0 $0C $ED $ED $00 $00 $66 $66 $00 $06 $EB $BE $00 $00 $BB $B0 $00 $00 $F0 $F0 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $08 $80 $00 $00 $88 $88 $00 $07 $87 $8E $80 $08 $88 $8E $80 $08 $88 $88 $80 $00 $88 $88 $00
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $88 $88 $00 $08 $88 $8E $80 $87 $87 $88 $E8 $88 $88 $88 $E8 $08 $88 $88 $80
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $08 $88 $88 $80 $88 $88 $8E $E8 $87 $87 $88 $E8 $88 $88 $88 $88
  $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $00 $88 $88 $00 $08 $88 $8E $80 $87 $87 $88 $E8 $88 $88 $88 $E8 $08 $88 $88 $80
.END

: TICKS 100 IN ;

: SIGN ?DUP IF DUP ABS / ELSE 0 THEN ;

: SCR-X! ( spr -- ) 1+  C! ;
: SCR-Y! ( spr -- ) 2 + C! ;
: SCR-X@ ( spr -- ) 1+  C@ ;
: SCR-Y@ ( spr -- ) 2 + C@ ;

: PROP! ( n spr -- ) 3 + C! ;
: PROP@ ( n spr -- ) 3 + C@ ;

: STEP ( anim -- )
  DUP     C@ ( INDEX ) 1+
  OVER 1+ C@ ( SIZE  ) %
  SWAP C! ;

: FRAME ( anim -- n )
  DUP C@ ( INDEX ) 2 + + C@ ;

: ANIMATE ( player anim -- )
  DUP STEP FRAME SWAP C! ;

: FACING
  PLAYER .VX @ 0 = IF
    PLAYER .FACING @
  ELSE
    PLAYER .VX @ SIGN DUP PLAYER .FACING !
  THEN ;

: LIFT PLAYER .VY @ SIGN ;

: PRESSED? ( key -- )
  PORT_KB OUT
  PORT_KB IN ;

: MOVEMENT-RELEASED
  KEY_RIGHT PRESSED? INVERT
  KEY_LEFT  PRESSED? INVERT
  AND ;

: APPLY-FRICTION
  MOVEMENT-RELEASED IF 
    FACING 0 > IF
      PLAYER .VX @ FRICTION - 0 MAX PLAYER .VX !
    ELSE
      PLAYER .VX @ FRICTION + 0 MIN PLAYER .VX !
    THEN
  THEN ;

: TILE-X TILE_WIDTH  / ;
: TILE-Y TILE_HEIGHT / ;

: TILE2 ( tx ty -- adr )
  #TILES_X 2 * * SWAP +
  $6300 + ;

: TILE ( x y -- adr )
  TILE-Y #TILES_X 2 * * SWAP TILE-X +
  $6300 + ;

: >TYPE ( n -- n )
  DUP 47 = OVER 38 = OR IF
    DROP AIR
    EXIT
  THEN
  DUP 64 = IF DROP SPIKE THEN
  0 OVER 40 BETWEEN?
    OVER 48 = OR
  IF
    DROP SOLID EXIT
  THEN
  DROP AIR ;

: TILE-W  PLAYER .WX @     PLAYER .WY @     TILE C@ >TYPE ;
: TILE-E  PLAYER .WX @ 7 + PLAYER .WY @     TILE C@ >TYPE ;
: TILE-SW PLAYER .WX @ 1+  PLAYER .WY @ 8 + TILE C@ >TYPE ;
: TILE-SE PLAYER .WX @ 7 + PLAYER .WY @ 8 + TILE C@ >TYPE ;
: TILE-NW PLAYER .WX @ 1+  PLAYER .WY @     TILE C@ >TYPE ;
: TILE-NE PLAYER .WX @ 7 + PLAYER .WY @     TILE C@ >TYPE ;

: ON-GROUND?
  TILE-SW SOLID =
  TILE-SE SOLID = OR ;

: CLAMP-VY
  PLAYER .VY @ MAX_FALL > IF
    MAX_FALL PLAYER .VY !
  THEN ;

: APPLY-GRAVITY
  GRAVITY PLAYER .VY +!
  CLAMP-VY ;

: CLAMP-VX
  PLAYER .VX @ MAX_VX > IF MAX_VX PLAYER .VX ! THEN
  PLAYER .VX @ MIN_VX < IF MIN_VX PLAYER .VX ! THEN ;

: ACCELERATE
  KEY_LEFT PRESSED? IF
    PLAYER .VX @ 0 > IF -BRAKING_AX ELSE -AX THEN
    PLAYER .VX +!
    CLAMP-VX
  ELSE
    KEY_RIGHT PRESSED? IF
      PLAYER .VX @ 0 < IF BRAKING_AX ELSE AX THEN
      PLAYER .VX +!
      CLAMP-VX
    THEN
  THEN ;

: START-JUMP
  PLAYER .JUMPING @ IF EXIT THEN
  TRUE PLAYER .JUMPING !
  JUMP_SPEED PLAYER .VY !
  0 JUMP_TIMER ! ;

: BOOST-JUMP
  JUMP_TIMER @ MAX_JUMP <
  PLAYER .JUMPING @ AND IF
    AY PLAYER .VY -!
    JUMP_TIMER INC!
  THEN ;

: JUMP
  ON-GROUND? IF
    START-JUMP
  ELSE
    BOOST-JUMP
  THEN ;

: .ENTRY ( door -- tx ty )
   DUP @ SWAP CELL + @ ;

: .EXIT  ( door -- tx ty )
   DUP  2 CELLS + @
   SWAP 3 CELLS + @ ;

: .STATUS ( door -- a ) 4 CELLS + ;

: DISTANCE ( x1 y1 x2 y2 -- n )
  ROT - ABS  \ |y2 - y1|
 -ROT
  SWAP - ABS \ |x2 - x1|
  + ;

: AT-TILE? ( tx ty -- bool )
  PLAYER .TILE DISTANCE 0 = ;

: AT-ENTRY? ( door -- bool ) .ENTRY AT-TILE? ;
: AT-EXIT?  ( door -- bool ) .EXIT  AT-TILE? ;

: OPEN? ( door - bool ) .STATUS C@ ;

: OPEN-DOOR ( door -- )
  TRUE SWAP .STATUS C! ;

: ENTER-DOOR ( door - )
  DUP OPEN-DOOR
  ( TODO move cam )
  .EXIT
  TILE_HEIGHT * PLAYER .WY !
  TILE_WIDTH  * PLAYER .WX !
  PLAYER .KEYS DEC! ;

: EXIT-DOOR  ( door - )
  .ENTRY
  TILE_HEIGHT * PLAYER .WY !
  TILE_WIDTH  * PLAYER .WX ! ;

: NTH-DOOR ( n -- door ) DOORS 1+ SWAP CELLS + @ ;

: HAS-KEY? PLAYER .KEYS @ 0 > ;
: CAN-ENTER? OPEN? HAS-KEY? OR ;
: #DOORS DOORS C@ ;

: CHECK-DOORS
  #DOORS 1-
  FOR
    I NTH-DOOR
    DUP  AT-ENTRY?
    OVER CAN-ENTER? AND IF
      ENTER-DOOR
    ELSE
      DUP AT-EXIT? IF EXIT-DOOR ELSE DROP THEN
    THEN
  NEXT ;

: KEYBOARD-INPUT
  KEY_SPACE PRESSED? IF JUMP ELSE FALSE PLAYER .JUMPING ! THEN
  ACCELERATE
  KEY_UP PRESSED? IF CHECK-DOORS THEN
  KEY_UP PRESSED?
  PLAYER .WX @ PLAYER .WY @ TILE C@ 43 = AND IF
    ( TODO: chest )
    0 HALT
  THEN ;

: MOVE-X
  PLAYER .VX @ DT @ * PLAYER .SX +!
  PLAYER .SX @ 8 ARSHIFT ?DUP IF
    PLAYER .WX +!
    $FF PLAYER .SX AND!
  THEN ;

: MOVE-Y
  PLAYER .VY @ DT @ * PLAYER .SY +!
  PLAYER .SY @ 8 ARSHIFT ?DUP IF
    PLAYER .WY +!
    $FF PLAYER .SY AND!
  THEN ;

: FINALIZE-X PLAYER .WX @ CAM_X @ - PLAYER @ SCR-X! ;
: FINALIZE-Y PLAYER .WY @ PLAYER @ SCR-Y! ;

: FLIP   PLAYER @ PROP@ %00000010 OR  PLAYER @ PROP! ;
: UNFLIP PLAYER @ PROP@ %11111101 AND PLAYER @ PROP! ;

: SET-FACING FACING 0 < IF FLIP ELSE UNFLIP THEN ;

: MOVING? PLAYER .VX @ 0 <> PLAYER .VY @ 0 <> OR ;

: SET-ANIMATION
  MOVING? IF RUNNING ELSE IDLE THEN ANIMATION ! ;

: COLLISION-X
  PLAYER .VX @ 0 < IF
    TILE-W SOLID = IF
      PLAYER .WX @ $FFF8 AND $08 + PLAYER .WX !
      0 PLAYER .SX !
      0 PLAYER .VX !
    THEN
  THEN
  PLAYER .VX @ 0 > IF
    TILE-E SOLID = IF
      $FFF8 PLAYER .WX AND!
      0 PLAYER .SX !
      0 PLAYER .VX !
    THEN
  THEN ;

: COLLISION-Y
  PLAYER .VY @ 0 > IF
    TILE-SW SOLID = 
    TILE-SE SOLID = OR IF
      $FFF8 PLAYER .WY AND!
      0 PLAYER .VY !
      0 PLAYER .SY !
    THEN
  THEN
  PLAYER .VY @ 0 < IF
    TILE-NW SOLID = 
    TILE-NE SOLID = OR IF
      PLAYER .WY @ $FFF8 AND $09 + PLAYER .WY !
      0 PLAYER .VY !
      0 PLAYER .SY !
    THEN
  THEN ;

: SHOW ( spr -- ) $01 SWAP PROP! ;

: MOVE-PLAYER
  MOVE-X
  APPLY-FRICTION
  COLLISION-X
  FINALIZE-X
  MOVE-Y
  APPLY-GRAVITY
  COLLISION-Y
  FINALIZE-Y ;

: DRAW-DOORS
  #DOORS 1-
  FOR
    I NTH-DOOR
    DUP OPEN? IF
      DUP .ENTRY    TILE2 46 SWAP C!
      DUP .ENTRY 1- TILE2 37 SWAP C!
      DUP .EXIT     TILE2 46 SWAP C!
          .EXIT  1- TILE2 37 SWAP C!
    ELSE
      DUP .ENTRY    TILE2 47 SWAP C!
      DUP .ENTRY 1- TILE2 38 SWAP C!
      DUP .EXIT     TILE2 47 SWAP C!
          .EXIT  1- TILE2 38 SWAP C!
    THEN
  NEXT ;

: DRAW
  DRAW-DOORS ;

: SCROLL
  PLAYER .WX @ SCROLL_START_X_RIGHT > IF
    PLAYER .WX @ SCROLL_START_X_RIGHT -
    0 MAX 256 MIN
    CAM_X !
  THEN
  CAM_X @ PORT_SCROLL OUT ;

ENTRY

$D3F2 PAL 0 CELLS + !
$FF42 PAL 1 CELLS + !

$D3F2 PAL 2 CELLS + !
$FF42 PAL 3 CELLS + !

PLAYER @ SHOW

BEGIN
  TIMER @ TICKS - ABS DT !

  DT @ 16 > IF   \ 60 FPS
    KEYBOARD-INPUT
    SET-FACING
    MOVE-PLAYER
    SCROLL
    SET-ANIMATION
    DRAW

    PLAYER .CENTER
    2DUP TILE C@ 42 = IF
      PLAYER .COINS INC!
      63 -ROT TILE C!
    ELSE
      2DUP TILE C@ 45 = IF
        PLAYER .KEYS INC!
        63 -ROT TILE C!
      ELSE
        2DROP
      THEN
    THEN
    
    \ " X=" PRINT PLAYER @ SCR-X@ . "  Y=" PRINT PLAYER SCR-Y@ .
    \ "  WX=" PRINT PLAYER .WX @ . "  WY=" PRINT PLAYER .WY @ .
    \ "  CX=" PRINT PLAYER .CENTER . "  CY=" PRINT .
    \ "  CAM_X=" PRINT CAM_X @ . CR

    DEPTH 0 <> IF
      " ERROR: " PRINT DEPTH . CR
    THEN
    

   \ PLAYER @ Y@ 8 + 224 >= IF 0 HALT THEN
    TICKS TIMER !

  THEN

  ANIM_TIMER @ TICKS - ABS 150 > IF
    PLAYER @ ANIMATION @ ANIMATE
    TICKS ANIM_TIMER !
  THEN

AGAIN

BYE
